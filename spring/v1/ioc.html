<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第1章 IoC | 好久不见的流星</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/assets/img/logo.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.6e451558.css" as="style"><link rel="preload" href="/assets/js/app.a41f5eca.js" as="script"><link rel="preload" href="/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/assets/js/13.5b563031.js" as="script"><link rel="prefetch" href="/assets/js/10.c398a4c5.js"><link rel="prefetch" href="/assets/js/11.a5d70000.js"><link rel="prefetch" href="/assets/js/12.738a1733.js"><link rel="prefetch" href="/assets/js/14.4066adb1.js"><link rel="prefetch" href="/assets/js/15.8d7d8951.js"><link rel="prefetch" href="/assets/js/16.f7974a37.js"><link rel="prefetch" href="/assets/js/3.a72851b7.js"><link rel="prefetch" href="/assets/js/4.fc333d27.js"><link rel="prefetch" href="/assets/js/5.bfef3080.js"><link rel="prefetch" href="/assets/js/6.2d0a63f8.js"><link rel="prefetch" href="/assets/js/7.66722a4b.js"><link rel="prefetch" href="/assets/js/8.fbcc9cdd.js"><link rel="prefetch" href="/assets/js/9.437719f4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6e451558.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="好久不见的流星" class="logo"> <span class="site-name can-hide">好久不见的流星</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/v1/" class="nav-link router-link-active">
  Spring 1.0
</a></li><li class="dropdown-item"><!----> <a href="/spring/v3/" class="nav-link">
  Spring 3.0
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/v1/" class="nav-link router-link-active">
  Spring 1.0
</a></li><li class="dropdown-item"><!----> <a href="/spring/v3/" class="nav-link">
  Spring 3.0
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/spring/v1/ioc.html" aria-current="page" class="active sidebar-link">第1章-IoC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#启动函数" class="sidebar-link">启动函数</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#refreshbeanfactory" class="sidebar-link">refreshBeanFactory</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#invokecontextconfigurers" class="sidebar-link">invokeContextConfigurers</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#loadoptions" class="sidebar-link">loadOptions</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#initmessagesource" class="sidebar-link">initMessageSource</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#onrefresh" class="sidebar-link">onRefresh</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#refreshlisteners" class="sidebar-link">refreshListeners</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#preinstantiatesingletons" class="sidebar-link">preInstantiateSingletons</a></li><li class="sidebar-sub-header"><a href="/spring/v1/ioc.html#publishevent" class="sidebar-link">publishEvent</a></li></ul></li><li><a href="/spring/v1/loadBean.html" class="sidebar-link">第2章-加载 Bean 信息</a></li><li><a href="/spring/v1/createBean.html" class="sidebar-link">第3章-创建 Bean 实例</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第1章-ioc"><a href="#第1章-ioc" class="header-anchor">#</a> 第1章 IoC</h1> <h2 id="启动函数"><a href="#启动函数" class="header-anchor">#</a> 启动函数</h2> <p>从这个入口，加载 xml 配置文件初始化应用上下文，然后调用 getBean 方法来获取指定对象。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ClassPathXmlApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;/testContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		clinic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Clinic</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;clinic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>就这样，来到了 refresh 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">FileSystemXmlApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> locations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>configLocation <span class="token operator">=</span> locations<span class="token punctuation">[</span>locations<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>接下来就看一下 Spring 是如何刷新的</p> <h2 id="refreshbeanfactory"><a href="#refreshbeanfactory" class="header-anchor">#</a> refreshBeanFactory</h2> <p>以流的形式加载 xml 配置文件，使用 xmlBeanFactory，设定父容器，设定 xml 解析器。然后开始使用 JDK 的 Document 解析器加载 Bean 信息，遍历 xml 配置信息，最终保存到 beanDefinitionMap 中。若有别名，则处理别名，将信息保存到 aliasMap 中。</p> <div class="language- extra-class"><pre class="language-text"><code>		try {
			// Supports remote as well as local URLs
			is = getInputStreamForBeanFactory();
			this.xmlBeanFactory = new XmlBeanFactory(getParent());
			this.xmlBeanFactory.setEntityResolver(new ResourceBaseEntityResolver(this));
			this.xmlBeanFactory.loadBeanDefinitions(is);
			}
		}
</code></pre></div><p>经过这个步骤，得到了两个产物：</p> <ol><li>保存 Bean 定义信息的 map</li> <li>保存 Bean 别名信息的 map</li></ol> <h2 id="invokecontextconfigurers"><a href="#invokecontextconfigurers" class="header-anchor">#</a> invokeContextConfigurers</h2> <p>根据类型 BeanFactoryPostProcessor.class 从 beanDefinitionMap 中获取对应的 Bean 信息，拿到一组 BeanNames ，遍历这组信息，获取到<strong>对应的 Bean 实例</strong>，回调其 postProcessBeanFactory 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanNames <span class="token operator">=</span> <span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> beanNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> beanName <span class="token operator">=</span> beanNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token class-name">BeanFactoryPostProcessor</span> configurer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			configurer<span class="token punctuation">.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre></div><h2 id="loadoptions"><a href="#loadoptions" class="header-anchor">#</a> loadOptions</h2> <p>根据固定的 Bean 名（contextOptions ）获取<strong>对应的 Bean 实例</strong>，若此实例为 ApplicationContextAware 并且不是单例 Bean 或者 managedSingletons 中不包含，则获取并保存到 managedSingletons 中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>contextOptions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ContextOptions</span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">OPTIONS_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bject bean <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationContextAware</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>managedSingletons<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ApplicationContextAware</span> aca <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
			aca<span class="token punctuation">.</span><span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>managedSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre></div><h2 id="initmessagesource"><a href="#initmessagesource" class="header-anchor">#</a> initMessageSource</h2> <p>根据固定的 Bean 名（messageSource）获取<strong>对应的 Bean 实例</strong>，若有父容器设定父容器。</p> <div class="language-java extra-class"><pre class="language-java"><code>			<span class="token keyword">this</span><span class="token punctuation">.</span>messageSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MessageSource</span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_SOURCE_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageSource <span class="token keyword">instanceof</span> <span class="token class-name">NestingMessageSource</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
 <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_SOURCE_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NestingMessageSource</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
</code></pre></div><h2 id="onrefresh"><a href="#onrefresh" class="header-anchor">#</a> onRefresh</h2> <p>钩子函数，空实现。</p> <h2 id="refreshlisteners"><a href="#refreshlisteners" class="header-anchor">#</a> refreshListeners</h2> <p>根据类型 ApplicationListener.class 获取 BeanNames，然后遍历 BeanNames 获取一组<strong>对应的 Bean 实例</strong>，然后再将这组实例保存到 eventMulticaster，即保存在 ApplicationEventMulticaster 中。</p> <div class="language- extra-class"><pre class="language-text"><code>		List listeners = BeanFactoryUtils.beansOfType(ApplicationListener.class, this);
		for (int i = 0; i &lt; listeners.size(); i++) {
			ApplicationListener listener = (ApplicationListener) listeners.get(i);
			addListener(listener);
		}
		ApplicationEventMulticaster eventMulticaster = new ApplicationEventMulticasterImpl();
		this.eventMulticaster.addApplicationListener(l);
</code></pre></div><h2 id="preinstantiatesingletons"><a href="#preinstantiatesingletons" class="header-anchor">#</a> preInstantiateSingletons</h2> <p>获取 beanDefinitionMap 中的 Bean 信息，若是单例 Bean 则初始化单例 Bean。</p> <div class="language- extra-class"><pre class="language-text"><code>		String[] beanNames = getBeanDefinitionNames();
		for (int i = 0; i &lt; beanNames.length; i++) {
			String beanName = beanNames[i];
			if (isSingleton(beanName)) {
				getBean(beanName);
			}
		}
</code></pre></div><h2 id="publishevent"><a href="#publishevent" class="header-anchor">#</a> publishEvent</h2> <p>调用 eventMulticaster 中存放的监听器，若有父类也一同调之。</p> <div class="language- extra-class"><pre class="language-text"><code>		this.eventMulticaster.onApplicationEvent(event);
		if (this.parent != null) {
			parent.publishEvent(event);
		}
</code></pre></div><p>至此，Bean 工厂初始化完毕。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/spring/v1/loadBean.html">
        第2章-加载 Bean 信息
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a41f5eca.js" defer></script><script src="/assets/js/2.733019b2.js" defer></script><script src="/assets/js/13.5b563031.js" defer></script>
  </body>
</html>
